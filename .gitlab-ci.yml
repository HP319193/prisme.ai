image: node:16

variables:
  DOCKER_DRIVER: overlay2
  GIT_DEPTH: '1'
  CONTAINER_BASE_IMAGE: registry.gitlab.com/$CI_PROJECT_PATH

  CONSOLE_DIRECTORY: 'console'
  CONSOLE_IMAGE_NAME: 'prisme.ai-console'
  CONSOLE_K8S_NAME: 'prismeai-console'

  PAGES_DIRECTORY: 'pages'
  PAGES_IMAGE_NAME: 'prisme.ai-pages'
  PAGES_K8S_NAME: 'prismeai-pages'

  WORKSPACES_DIRECTORY: 'workspaces'
  WORKSPACES_IMAGE_NAME: 'prisme.ai-workspaces'
  WORKSPACES_K8S_NAME: 'prismeai-workspaces'

  API_GATEWAY_DIRECTORY: 'api-gateway'
  API_GATEWAY_IMAGE_NAME: 'prisme.ai-api-gateway'
  API_GATEWAY_K8S_NAME: 'prismeai-api-gateway'

  RUNTIME_DIRECTORY: 'runtime'
  RUNTIME_IMAGE_NAME: 'prisme.ai-runtime'
  RUNTIME_K8S_NAME: 'prismeai-runtime'

  EVENTS_DIRECTORY: 'events'
  EVENTS_IMAGE_NAME: 'prisme.ai-events'
  EVENTS_K8S_NAME: 'prismeai-events'

stages:
  - test
  - dependencies
  - build_docker
  - deploy
  - performance

# sast:
#   stage: test
# include:
#   - template: Security/SAST.gitlab-ci.yml

backend_npm_install:
  stage: dependencies
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^feature\/.*$/
      changes: &BACKEND_DEPS_CHANGES
        - 'services/api-gateway/package.json'
        - 'services/runtime/package.json'
        - 'services/workspaces/package.json'
        - 'services/events/package.json'
        - 'packages/permissions/**/*'
        - 'packages/broker/**/*'
        - 'specifications/swagger.yml'
      when: manual
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG'
      changes: *BACKEND_DEPS_CHANGES
  image: docker:stable
  services:
    - docker:stable-dind
  script:
    - >
      if [ -n "$CI_COMMIT_TAG" ] ; then
        export FEATURE_TAG=prod
      elif [ -z "$CI_COMMIT_BRANCH" ] || [ "$CI_COMMIT_BRANCH" == "main" ] || [ "$CI_COMMIT_BRANCH" == "master" ]; then
        export FEATURE_TAG=latest
      else
        export FEATURE_TAG=$(echo "${CI_COMMIT_BRANCH}" | tr \/ -)
      fi

    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.gitlab.com
    - docker pull $CONTAINER_BASE_IMAGE/prisme.ai-dependencies:latest || true
    - docker build . -f dependencies.dockerfile -t prisme.ai-dependencies -t $CONTAINER_BASE_IMAGE/prisme.ai-dependencies:$FEATURE_TAG --cache-from $CONTAINER_BASE_IMAGE/prisme.ai-dependencies:latest
    - docker push $CONTAINER_BASE_IMAGE/prisme.ai-dependencies:$FEATURE_TAG

#### Parent jobs

.npm_test:
  stage: test
  script:
    - >
      if ! [[ -d node_modules/ ]] ; then
        BUILD_PACKAGES=0 npm ci
      fi
    - npm run build:packages
    - npm test -- $DIRECTORY --coveragePathIgnorePatterns "./packages/*"
  coverage: '/All files\s+\|\s+([\d\.]+)\s+\|\s+([\d\.]+)\s+\|\s+([\d\.]+)\s+\|\s+([\d\.]+)/'
  artifacts:
    paths:
      - coverage
  cache: &cache
    key:
      files: &lockFiles
        - package-lock.json
    paths:
      - node_modules/

.build_docker:
  stage: build_docker
  image: docker:stable
  services:
    - docker:stable-dind
  script:
    - echo "sha = $CI_COMMIT_SHORT_SHA"
    - echo "tag = $CI_COMMIT_TAG"
    - export CACHE_FROM=latest
    - >
      if [ -n "$CI_COMMIT_TAG" ] ; then
        export FEATURE_TAG=$CI_COMMIT_TAG
        export DEPENDENCIES_TAG=prod
        export ALIAS_TAG=prod
      elif [ -z "$CI_COMMIT_BRANCH" ] || [ "$CI_COMMIT_BRANCH" == "main" ] || [ "$CI_COMMIT_BRANCH" == "master" ]; then
        export FEATURE_TAG=latest
        export DEPENDENCIES_TAG=$FEATURE_TAG
        export ALIAS_TAG=latest
      else
        export FEATURE_TAG=$(echo "${CI_COMMIT_BRANCH}" | tr \/ -)
        export DEPENDENCIES_TAG=$FEATURE_TAG
        export CACHE_FROM=$FEATURE_TAG
        export ALIAS_TAG=$FEATURE_TAG
      fi

    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.gitlab.com
    - docker pull $IMAGE_NAME:latest || true
    - docker build  --build-arg DEPENDENCIES_TAG=$DEPENDENCIES_TAG --cache-from $IMAGE_NAME:$CACHE_FROM -t $IMAGE_NAME:$FEATURE_TAG -t $IMAGE_NAME:$ALIAS_TAG . -f $DIRECTORY/Dockerfile
    - docker push $IMAGE_NAME:$FEATURE_TAG
    - docker push $IMAGE_NAME:$ALIAS_TAG

.deploy_k8s:
  stage: deploy
  tags:
    - internal-runner
  image:
    name: registry.gitlab.com/gogowego-devsecops/dev/prisme.ai-infra:latest
    entrypoint: ['/bin/sh', '-c']
  script:
    - echo "sha = $CI_COMMIT_SHORT_SHA"
    - echo "tag = $CI_COMMIT_TAG"
    - echo "branch = $CI_COMMIT_BRANCH"
    - >
      if [ -n "$CI_COMMIT_TAG"  ] ; then
        export FEATURE_TAG=$CI_COMMIT_TAG
        export CI_COMMIT_BRANCH=prod
      elif [ -z "$CI_COMMIT_BRANCH" ] || [ "$CI_COMMIT_BRANCH" == "main" ] || [ "$CI_COMMIT_BRANCH" == "master" ]; then
        export FEATURE_TAG=latest
      else
        export FEATURE_TAG=$(echo "${CI_COMMIT_BRANCH}" | tr \/ -)
      fi
    - deploy $CI_COMMIT_BRANCH $K8S_NAME $IMAGE_NAME $FEATURE_TAG

## Console jobs
console_check:
  stage: test
  script:
    - >
      if ! [[ -d node_modules/ ]] ; then
        BUILD_PACKAGES=0 npm ci
      fi
    - npm run build:packages
    - npm run check:console
  needs: []
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes: &CONSOLE_CHANGES
        - 'services/console/**/*'
    - !reference [console_build_docker, rules]
  before_script:
    - export DIRECTORY=services/$CONSOLE_DIRECTORY

console_test:
  extends: .npm_test
  needs: []
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes: *CONSOLE_CHANGES
    - !reference [console_build_docker, rules]
  before_script:
    - export DIRECTORY=services/$CONSOLE_DIRECTORY

console_build_docker:
  extends: .build_docker
  needs:
    - console_test
  stage: build_docker
  image: docker:stable
  services:
    - docker:stable-dind
  rules: &CONSOLE_DEPLOY_RULES
    - if: $CI_COMMIT_BRANCH =~ /^feature\/.*$/
      changes: *CONSOLE_CHANGES
      when: manual
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG'
      changes: *CONSOLE_CHANGES
  before_script:
    - export DIRECTORY=services/$CONSOLE_DIRECTORY
    - export DOCKER_HOST=tcp://docker:2375
    - export IMAGE_NAME=$CONTAINER_BASE_IMAGE/$CONSOLE_IMAGE_NAME

console_deploy:
  extends: .deploy_k8s
  needs:
    - console_build_docker
  rules: *CONSOLE_DEPLOY_RULES
  before_script:
    - export KUBECONFIG=$KUBECONFIG
    - export IMAGE_NAME=$CONTAINER_BASE_IMAGE/$CONSOLE_IMAGE_NAME
    - export K8S_NAME=$CONSOLE_K8S_NAME

## Pages jobs
# No tests yet

# pages_check:
#   stage: test
#   script:
#     - >
#       if ! [[ -d node_modules/ ]] ; then
#         BUILD_PACKAGES=0 npm ci
#       fi
#     - npm run build:packages
#     - npm run check:pages
#   needs: []
#   only:
#     changes:
#       - 'services/pages/**/*'
#   before_script:
#     - export DIRECTORY=services/$PAGES_DIRECTORY

# pages_test:
#   extends: .npm_test
#   needs: []
#   only:
#     changes:
#       - 'services/pages/**/*'
#   before_script:
#     - export DIRECTORY=services/$PAGES_DIRECTORY

pages_build_docker:
  extends: .build_docker
  # needs:
  #   - pages_test
  stage: build_docker
  image: docker:stable
  services:
    - docker:stable-dind
  rules: &PAGES_DEPLOY_RULES
    - if: $CI_COMMIT_BRANCH =~ /^feature\/.*$/
      changes: &PAGES_CHANGES
        - 'services/pages/**/*'
      when: manual
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG'
      changes: *PAGES_CHANGES
  before_script:
    - export DIRECTORY=services/$PAGES_DIRECTORY
    - export DOCKER_HOST=tcp://docker:2375
    - export IMAGE_NAME=$CONTAINER_BASE_IMAGE/$PAGES_IMAGE_NAME

pages_deploy:
  extends: .deploy_k8s
  needs:
    - pages_build_docker
  rules: *PAGES_DEPLOY_RULES
  before_script:
    - export KUBECONFIG=$KUBECONFIG
    - export IMAGE_NAME=$CONTAINER_BASE_IMAGE/$PAGES_IMAGE_NAME
    - export K8S_NAME=$PAGES_K8S_NAME

## Workspaces jobs
workspaces_test:
  extends: .npm_test
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes: &WORKSPACES_CHANGES
        - 'services/workspaces/**/*'
    - !reference [workspaces_build_docker, rules]
  before_script:
    - export DIRECTORY=services/$WORKSPACES_DIRECTORY/src

workspaces_build_docker:
  extends: .build_docker
  needs:
    - workspaces_test
  interruptible: true # Stop this job if a new one has been triggered by the same branch
  stage: build_docker
  image: docker:stable
  services:
    - docker:stable-dind
  rules: &WORKSPACES_DEPLOY_RULES
    - if: $CI_COMMIT_BRANCH =~ /^feature\/.*$/
      changes: *WORKSPACES_CHANGES
      when: manual
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG'
      changes: *WORKSPACES_CHANGES
  before_script:
    - export DIRECTORY=services/$WORKSPACES_DIRECTORY
    - export DOCKER_HOST=tcp://docker:2375
    - export IMAGE_NAME=$CONTAINER_BASE_IMAGE/$WORKSPACES_IMAGE_NAME

workspaces_deploy:
  extends: .deploy_k8s
  needs:
    - workspaces_build_docker
  tags:
    - internal-runner
  image:
    name: registry.gitlab.com/gogowego-devsecops/dev/prisme.ai-infra:latest
    entrypoint: ['/bin/sh', '-c']
  rules: *WORKSPACES_DEPLOY_RULES
  before_script:
    - export KUBECONFIG=$KUBECONFIG
    - export IMAGE_NAME=$CONTAINER_BASE_IMAGE/$WORKSPACES_IMAGE_NAME
    - export K8S_NAME=$WORKSPACES_K8S_NAME

## Runtime jobs
runtime_test:
  extends: .npm_test
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes: &RUNTIME_CHANGES
        - 'services/runtime/**/*'
    - !reference [runtime_build_docker, rules]
  before_script:
    - export DIRECTORY=services/$RUNTIME_DIRECTORY

runtime_build_docker:
  extends: .build_docker
  needs:
    - runtime_test
  interruptible: true # Stop this job if a new one has been triggered by the same branch
  stage: build_docker
  image: docker:stable
  services:
    - docker:stable-dind
  rules: &RUNTIME_DEPLOY_RULES
    - if: $CI_COMMIT_BRANCH =~ /^feature\/.*$/
      changes: *RUNTIME_CHANGES
      when: manual
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG'
      changes: *RUNTIME_CHANGES
  before_script:
    - export DIRECTORY=services/$RUNTIME_DIRECTORY
    - export DOCKER_HOST=tcp://docker:2375
    - export IMAGE_NAME=$CONTAINER_BASE_IMAGE/$RUNTIME_IMAGE_NAME

runtime_deploy:
  extends: .deploy_k8s
  needs:
    - runtime_build_docker
  rules: *RUNTIME_DEPLOY_RULES
  before_script:
    - export KUBECONFIG=$KUBECONFIG
    - export IMAGE_NAME=$CONTAINER_BASE_IMAGE/$RUNTIME_IMAGE_NAME
    - export K8S_NAME=$RUNTIME_K8S_NAME

## API Gateway jobs
api-gateway_build_docker:
  extends: .build_docker
  interruptible: true # Stop this job if a new one has been triggered by the same branch
  stage: build_docker
  image: docker:stable
  services:
    - docker:stable-dind
  rules: &API_GATEWAY_DEPLOY_RULES
    - if: $CI_COMMIT_BRANCH =~ /^feature\/.*$/
      changes: &API_GATEWAY_CHANGES
        - 'services/api-gateway/**/*'
      when: manual
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG'
      changes: *API_GATEWAY_CHANGES
  before_script:
    - export DIRECTORY=services/$API_GATEWAY_DIRECTORY
    - export DOCKER_HOST=tcp://docker:2375
    - export IMAGE_NAME=$CONTAINER_BASE_IMAGE/$API_GATEWAY_IMAGE_NAME

api-gateway_deploy:
  extends: .deploy_k8s
  needs:
    - api-gateway_build_docker
  rules: *API_GATEWAY_DEPLOY_RULES
  before_script:
    - export KUBECONFIG=$KUBECONFIG
    - export IMAGE_NAME=$CONTAINER_BASE_IMAGE/$API_GATEWAY_IMAGE_NAME
    - export K8S_NAME=$API_GATEWAY_K8S_NAME

## Events jobs
events_test:
  extends: .npm_test
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes: &EVENTS_CHANGES
        - 'services/events/**/*'
    - !reference [events_build_docker, rules]
  before_script:
    - export DIRECTORY=services/$EVENTS_DIRECTORY

events_build_docker:
  extends: .build_docker
  needs:
    - events_test
  interruptible: true # Stop this job if a new one has been triggered by the same branch
  stage: build_docker
  image: docker:stable
  services:
    - docker:stable-dind
  rules: &EVENTS_DEPLOY_RULES
    - if: $CI_COMMIT_BRANCH =~ /^feature\/.*$/
      changes: &EVENTS_CHANGES
        - 'services/events/**/*'
      when: manual
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG'
      changes: *EVENTS_CHANGES
  before_script:
    - export DIRECTORY=services/$EVENTS_DIRECTORY
    - export DOCKER_HOST=tcp://docker:2375
    - export IMAGE_NAME=$CONTAINER_BASE_IMAGE/$EVENTS_IMAGE_NAME

events_deploy:
  extends: .deploy_k8s
  needs:
    - events_build_docker
  rules: *EVENTS_DEPLOY_RULES
  before_script:
    - export KUBECONFIG=$KUBECONFIG
    - export IMAGE_NAME=$CONTAINER_BASE_IMAGE/$EVENTS_IMAGE_NAME
    - export K8S_NAME=$EVENTS_K8S_NAME

## Docs jobs
docs_build_static:
  stage: build_docker
  needs: []
  interruptible: true # Stop this job if a new one has been triggered by the same branch
  only:
    refs:
      - main
      - master
      - /^feature\/.*$/
      - /^pipeline\/.*$/
      - /^doc\/.*$/
    changes:
      - 'docs/**/*'
      - 'specifications/*'
  image: python:latest
  script:
    - cp ./specifications/swagger.yml docs/public/api/swagger.yml
    - cd docs
    - apt-get update && apt-get install -y nodejs npm
    - npm ci
    - pip install mkdocs-material==6.2.5
    - bash ./build.sh all
  artifacts:
    paths:
      - docs/public

.s3_deploy:
  stage: deploy
  image: python:alpine
  before_script:
    - pip install awscli

docs_deploy:
  extends: .s3_deploy
  needs:
    - docs_build_static
  only:
    refs:
      - main
      - /^doc\/.*$/
    changes:
      - 'docs/**/*'
      - 'specifications/*'
  script:
    - aws s3 rm s3://$DOCS_S3_BUCKET_NAME --recursive
    - aws s3 cp docs/public/ s3://$DOCS_S3_BUCKET_NAME/ --recursive --include "*"
    - aws cloudfront create-invalidation --distribution-id $DOCS_CDN_DISTRIBUTION_ID --paths "/*"

load_performance:
  stage: performance
  when: manual
  image:
    name: loadimpact/k6:latest
    entrypoint: ['']
  variables:
    K6_TEST_FILE: scripts/loadPerformanceTesting.js
    K6_OPTIONS: ''
  script:
    - k6 run $K6_TEST_FILE --summary-export=load-performance.json $K6_OPTIONS
  artifacts:
    reports:
      load_performance: load-performance.json
