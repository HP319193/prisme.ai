# Prisme.ai Documentation

## Workflow

Every modification pushed to **master** branch will be deployed on https://obsidienne.prisme.ai.  
In order to deploy in production once every modification is approved, thanks to merge **master** branch into **prod** branch, which will automatically update https://docs.prisme.ai.  

## Local development 
### Installation
```
pip install mkdocs-material
```

### Usage

#### Build and serve a specific lang
```
./serve.sh fr
```
This command watches any modification made to **docs/fr** files so that local webserver stays up to date.   
Since each language is generated by a distinct mkdocs build, we currently cannot locally work on multiples languages with a single webserver.  

#### Statically build a specific lang
```
./build.sh fr
```
Creates **public/fr** folder, ready to be served over HTTP.  

#### Statically build every langs
```
./build.sh all
```

This command will produce a **public** folder containing a subdirectory for each language.  
In order to serve this **public** folder over HTTP, a web redirection will be needed to serve the default language subdirectory. More details in **Deploy on S3**.  

## Initial AWS S3 setup 
1. Create a new S3 bucket
2. Untick every options from **Permissions > Block public access**
3. Paste following policy inside **Permissions > Bucket Policy** in order to make the bucket publicly available :
```
{
    "Statement": [
        {
            "Sid": "PublicReadForGetBucketObjects",
            "Effect": "Allow",
            "Principal": "*",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::INSERT_BUCKET_NAME/*"
        }
    ]
}
```
4. In **Properties** tab, enable static website hosting & paste the following redirect requests in order to enable default lang redirection & localized 404 pages :
```
<RoutingRules>
  <RoutingRule>
    <Condition>
      <KeyPrefixEquals>fr/</KeyPrefixEquals>
      <HttpErrorCodeReturnedEquals>404</HttpErrorCodeReturnedEquals>
    </Condition>
    <Redirect>
      <HostName>docs.prisme.ai</HostName>
      <ReplaceKeyWith>fr/404.html</ReplaceKeyWith>
    </Redirect>
  </RoutingRule>
  <RoutingRule>
    <Condition>
      <KeyPrefixEquals>en/</KeyPrefixEquals>
      <HttpErrorCodeReturnedEquals>404</HttpErrorCodeReturnedEquals>
    </Condition>
    <Redirect>
      <HostName>docs.prisme.ai</HostName>
      <ReplaceKeyWith>en/404.html</ReplaceKeyWith>
    </Redirect>
  </RoutingRule>
  <RoutingRule>
    <Condition>
      <KeyPrefixEquals/>
      <HttpErrorCodeReturnedEquals>404</HttpErrorCodeReturnedEquals>
    </Condition>
    <Redirect>
      <HostName>docs.prisme.ai</HostName>
      <ReplaceKeyWith>en/index.html</ReplaceKeyWith>
    </Redirect>
  </RoutingRule>
</RoutingRules>
```
Update **HostName** tags with the desired public DNS  
5. Copy the **Endpoint** url shown at the top of the **Static website hosting** area, we will need it later

Now, lets's move on our CloudFront distribution with a custom HTTPS-enabled domain :
1. Open AWS **Certificate Manager** service in **N.Virginia** region : we won't be able to use our certificate from CloudFront if we don't specify this precise region
2. Issue a new certificate with the desired DNS
3. Once the certificate is ready, create a **Web** distribution within **CloudFront** service
4. In **Origin Domain Name** input, paste the previously copied **Endpoint** url **without the leading http://**
5. As soon as this input looses focus, **Origin ID** should be automatically fulfilled
6. Enable **Redirect HTTP to HTTPS** option in **Viewer Protocol Policy**
7. In **Distribution Settings**, tick **Custom SSL Certificate** and select the previously created certificate
8. Write the desired DNS in **Alternate Domain Names**  
9. **Create distribution**
10. Open this new distribution details and copy the **Domain Name**
11. Create a new DNS CNAME rule redirecting the desired DNS to this **Domain Name**
12. Wait for the DNS propagation, and we're done
